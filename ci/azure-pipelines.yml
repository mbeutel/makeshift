# Azure Pipelines configuration for makeshift

variables:
  system.debug: true
  vcpkgGitRef: 2aaf7fd8b3d7dce245c5ce2d41aa3fdb6f0f7438
  vcpkgPortsOverlayRepo: 'https://mp-force.ziti.uni-heidelberg.de/asc/infrastructure/vcpkg-ports.git'
  vcpkgPortsOverlayRef: 09240a899e6575a217a267b26a7c378d0e7d3374
  cmakeConfigArgs: '-DBUILD_TESTS=ON'
  revision: 1

jobs:
  - job: Windows2019_VS2019

    strategy:
      matrix: 
        Debug_x86:
          Config: Debug
          Platform: x86
        Release_x86:
          Config: RelWithDebInfo
          Platform: x86
        Debug_x64:
          Config: Debug
          Platform: x64
        Release_x64:
          Config: RelWithDebInfo
          Platform: x64

    pool:
      name: Azure Pipelines
      vmImage: 'windows-2019'

    steps:
      - task: CacheBeta@0
        displayName: Cache dependencies
        inputs:
          key: '$(Build.SourcesDirectory)/ci/vcpkg.txt | "$(vcpkgGitRef)" | "$(vcpkgPortsOverlayRef)" | "$(Agent.OS)" | "$(Platform)" | "$(revision)"'
          path: '$(Build.BinariesDirectory)/dependencies'
          cacheHitVar: 'dependencyCacheHit'

      - script: git clone --depth 1 $(vcpkgPortsOverlayRepo) "$(Build.BinariesDirectory)/dependencies/ports-overlay-repo"
        displayName: Clone ports overlay repository
        condition: ne(variables.dependencyCacheHit, 'true')

      - script: |
          tree /F /A
        displayName: Display cache content
        condition: eq(variables.dependencyCacheHit, 'true')
        workingDirectory: '$(Pipeline.Workspace)'

      - task: run-vcpkg@0
        displayName: Run Vcpkg to install dependencies
        inputs:
          vcpkgDirectory: '$(Build.BinariesDirectory)/dependencies/vcpkg'
          vcpkgGitCommitId: '$(vcpkgGitRef)'
          vcpkgTriplet: '$(Platform)-windows'
          vcpkgArguments: '--overlay-ports="$(Build.BinariesDirectory)/dependencies/ports-overlay-repo/vcpkg/ports" "@$(Build.SourcesDirectory)/ci/vcpkg.txt"'
          vcpkgArtifactIgnoreEntries: |
            buildtrees/
            downloads/
            packages/

      - task: run-cmake@0
        displayName: Build
        inputs:
          cmakeListsOrSettingsJson: 'CMakeListsTxtAdvanced'
          useVcpkgToolchainFile: true
          buildDirectory: '$(Build.BinariesDirectory)/build'
          cmakeAppendedArgs: '-G Ninja -DCMAKE_BUILD_TYPE=$(Config) $(cmakeConfigArgs)'

      - script: |
          ctest -V
        displayName: Run tests
        failOnStderr: true
        workingDirectory: '$(Build.BinariesDirectory)/build'
        
  - job: Ubuntu1808_GCC9

    variables:
      cmakeVersion: 3.15
      cmakeBuild: 4

    strategy:
      matrix: 
        Debug:
          Config: Debug
          Platform: x64
        Release:
          Config: RelWithDebInfo
          Platform: x64

    pool:
      name: Azure Pipelines
      vmImage: 'ubuntu-18.04'

    steps:
      - script: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test
          sudo apt update
          sudo apt install gcc-9
        displayName: Install GCC 9
        
      - script: |
          echo "##vso[task.setvariable variable=CC]gcc-9"
          echo "##vso[task.setvariable variable=CXX]g++-9"
        displayName: Set GCC 9 as default compiler
          
      - task: CacheBeta@0
        displayName: Cache dependencies
        inputs:
          key: '$(Build.SourcesDirectory)/ci/vcpkg.txt | "$(vcpkgGitRef)" | "$(vcpkgPortsOverlayRef)" | "$(Agent.OS)" | "$(Platform)" | "$(revision)" | "cmake-$(cmakeVersion).$(cmakeBuild)" '
          path: '$(Build.BinariesDirectory)/dependencies'
          cacheHitVar: 'dependencyCacheHit'

      - script: git clone --depth 1 $(vcpkgPortsOverlayRepo) "$(Build.BinariesDirectory)/dependencies/ports-overlay-repo"
        displayName: Clone ports overlay repository
        condition: ne(variables.dependencyCacheHit, 'true')

      - script: |
          sudo apt install tree
          tree -a
        displayName: Display cache content
        condition: eq(variables.dependencyCacheHit, 'true')
        workingDirectory: '$(Pipeline.Workspace)'

      - script: |
          mkdir ~/temp
          cd ~/temp
          wget https://cmake.org/files/v$(cmakeVersion)/cmake-$(cmakeVersion).$(cmakeBuild)-Linux-x86_64.sh 
          sudo mkdir -p "$(Build.BinariesDirectory)/dependencies/cmake"
          sudo sh cmake-$(cmakeVersion).$(cmakeBuild)-Linux-x86_64.sh --prefix="$(Build.BinariesDirectory)/dependencies/cmake" --skip-license
          echo "##vso[task.setvariable variable=PATH]$(Build.BinariesDirectory)/dependencies/cmake/bin:${PATH}"
        displayName: 'Install CMake $(cmakeVersion)'
        condition: ne(variables.dependencyCacheHit, 'true')
        failOnStderr: true

      - task: run-vcpkg@0
        displayName: Run Vcpkg to install dependencies
        inputs:
          vcpkgDirectory: '$(Build.BinariesDirectory)/dependencies/vcpkg'
          vcpkgGitCommitId: '$(vcpkgGitRef)'
          vcpkgTriplet: '$(Platform)-linux'
          vcpkgArguments: '--overlay-ports="$(Build.BinariesDirectory)/dependencies/ports-overlay-repo/vcpkg/ports" "@$(Build.SourcesDirectory)/ci/vcpkg.txt"'
          vcpkgArtifactIgnoreEntries: |
            buildtrees/
            downloads/
            packages/

      - task: run-cmake@0
        displayName: Build
        inputs:
          cmakeListsOrSettingsJson: 'CMakeListsTxtAdvanced'
          useVcpkgToolchainFile: true
          buildDirectory: '$(Build.BinariesDirectory)/build'
          cmakeAppendedArgs: '-DCMAKE_BUILD_TYPE=$(Config) $(cmakeConfigArgs)'

      - script: |
          ctest -V
        displayName: Run tests
        failOnStderr: true
        workingDirectory: '$(Build.BinariesDirectory)/build'
